import telebot
import json
import os
from datetime import datetime, timedelta
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
from flask import Flask
import threading
import random

TOKEN = os.getenv('TOKEN')
bot = telebot.TeleBot(TOKEN)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
days_map = {
    '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–ø–Ω': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '1': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', 'monday': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
    '–≤—Ç–æ—Ä–Ω–∏–∫': '–≤—Ç–æ—Ä–Ω–∏–∫', '–≤—Ç': '–≤—Ç–æ—Ä–Ω–∏–∫', '2': '–≤—Ç–æ—Ä–Ω–∏–∫', 'tuesday': '–≤—Ç–æ—Ä–Ω–∏–∫',
    '—Å—Ä–µ–¥–∞': '—Å—Ä–µ–¥–∞', '—Å—Ä': '—Å—Ä–µ–¥–∞', '3': '—Å—Ä–µ–¥–∞', 'wednesday': '—Å—Ä–µ–¥–∞',
    '—á–µ—Ç–≤–µ—Ä–≥': '—á–µ—Ç–≤–µ—Ä–≥', '—á—Ç': '—á–µ—Ç–≤–µ—Ä–≥', '4': '—á–µ—Ç–≤–µ—Ä–≥', 'thursday': '—á–µ—Ç–≤–µ—Ä–≥',
    '–ø—è—Ç–Ω–∏—Ü–∞': '–ø—è—Ç–Ω–∏—Ü–∞', '–ø—Ç': '–ø—è—Ç–Ω–∏—Ü–∞', '5': '–ø—è—Ç–Ω–∏—Ü–∞', 'friday': '–ø—è—Ç–Ω–∏—Ü–∞'
}

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —É—á–µ–±–Ω—ã–µ –¥–Ω–∏
schedule = {
  "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üéØ –í–Ω–µ—É—Ä–æ—á–∫–∞: –†–∞–∑–≥–æ–≤–æ—Ä—ã –æ –≤–∞–∂–Ω–æ–º"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üß† –í–Ω–µ—É—Ä–æ—á–∫–∞: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å"}
  ],
  "–≤—Ç–æ—Ä–Ω–∏–∫": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üåç –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üî¢ –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}
  ],
  "—Å—Ä–µ–¥–∞": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üèÉ‚Äç‚ôÇÔ∏è –í–Ω–µ—É—Ä–æ—á–∫–∞: –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üéµ –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú—É–∑—ã–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üî® –¢—Ä—É–¥"}
  ],
  "—á–µ—Ç–≤–µ—Ä–≥": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üé® –í–Ω–µ—É—Ä–æ—á–∫–∞: –ò–ó–û"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üèõÔ∏è –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–æ—è –ú–æ—Å–∫–≤–∞"}
  ],
  "–ø—è—Ç–Ω–∏—Ü–∞": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üåç –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üèÉ‚Äç‚ôÇÔ∏è –í–Ω–µ—É—Ä–æ—á–∫–∞: –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üî¢ –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}
  ]
}

print("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–π –Ω–µ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!")

# üé® –ö–õ–ê–í–ò–ê–¢–£–†–ê: —Ç–æ–ª—å–∫–æ –ü–ù-–ü–¢, –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –ø–µ—Ä–≤—ã–π!
def get_days_keyboard():
    today = datetime.now()
    russian_days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞"]
    
    markup = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    
    # –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ —Å–ª–µ–¥—É—é—â–∏–µ 4 –¥–Ω—è
    days_ahead = (0 - today.weekday()) % 7  # –î–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
    monday = today + timedelta(days=days_ahead)
    
    for i in range(5):  # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ü—è—Ç–Ω–∏—Ü–∞
        current_day = monday + timedelta(days=i)
        day_name = russian_days[i]
        date_str = current_day.strftime("%d.%m")
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
        emojis = ["üîµ", "üü¢", "üü°", "üü†", "üî¥"]
        button_text = f"{emojis[i]} {date_str} ({day_name})"
        markup.add(KeyboardButton(button_text))
    
    return markup

# üöÄ –°–¢–ê–†–¢
@bot.message_handler(commands=['start'])
def start(message):
    greetings = [
        "üîî –ü—Ä–∏–≤–µ—Ç, –¢–∏–º–æ—à–∞! –£—á–µ–±–Ω–∞—è –Ω–µ–¥–µ–ª—è –≤–ø–µ—Ä–µ–¥–∏! üìö‚ú®",
        "üéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏ –¥–µ–Ω—å –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:",
        "üëã –¢–≤–æ–π –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –≥–æ—Ç–æ–≤! –ö–∞–∫–æ–π –¥–µ–Ω—å? üöÄ"
    ]
    bot.reply_to(message, 
        random.choice(greetings),
        reply_markup=get_days_keyboard())

# üß† –û–ë–†–ê–ë–û–¢–ö–ê
@bot.message_handler(content_types=['text'])
def handle_day(message):
    day_input = message.text.lower().strip()
    
    # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏
    day_input = ''.join(c for c in day_input if c.isalpha() or c.isspace())
    day_input = day_input.replace('üìÖ', '').replace('üîµ', '').replace('üü¢', '').replace('üü°', '').replace('üü†', '').replace('üî¥', '')
    day_input = ' '.join(day_input.split())
    
    # –ò—â–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    day = None
    for key in days_map:
        if key in day_input:
            day = days_map[key]
            break
    
    if not day:
        bot.reply_to(message, 
            "‚ùì –í—ã–±–µ—Ä–∏ —É—á–µ–±–Ω—ã–π –¥–µ–Ω—å (–ü–Ω-–ü—Ç) –∏–ª–∏ –Ω–∞–ø–∏—à–∏: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –≤—Ç–æ—Ä–Ω–∏–∫...",
            reply_markup=get_days_keyboard())
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    text = f"üìö <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ {day.capitalize()}</b>\n\n"
    for lesson in schedule[day]:
        text += f"‚è∞ <b>{lesson['–≤—Ä–µ–º—è']}</b> ‚Äî {lesson['—É—Ä–æ–∫']}\n"
    
    tips = ["üí™ –£—á–∏—Å—å —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º!", "üìñ –¢—ã –ª—É—á—à–∏–π! ‚ú®", "üéØ –í—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è!"]
    text += f"\n<i>{random.choice(tips)}</i>"
    
    bot.reply_to(message, text, parse_mode='HTML', reply_markup=get_days_keyboard())

# /HELP
@bot.message_handler(commands=['help'])
def help_command(message):
    bot.reply_to(message, 
        "üÜò <b>–¢–≤–æ–π –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫:</b>\n\n"
        "üìÖ <b>–£—á–µ–±–Ω—ã–µ –¥–Ω–∏:</b> –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ü—è—Ç–Ω–∏—Ü–∞\n"
        "üí¨ <b>–ü–∏—à–∏:</b> –ø–Ω, –≤—Ç, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫...\n\n"
        "‚ú® –†–∞–±–æ—Ç–∞–µ—Ç 24/7!",
        parse_mode='HTML', reply_markup=get_days_keyboard())

# –í–µ–±-—Å–µ—Ä–≤–µ—Ä Render
app = Flask(__name__)

@app.route("/")
def hello():
    return "üîî –ë–æ—Ç –¢–∏–º–æ—à–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! üìö"

def run_flask():
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)

if __name__ == "__main__":
    flask_thread = threading.Thread(target=run_flask)
    flask_thread.daemon = True
    flask_thread.start()
    
    print("üöÄ –ë–æ—Ç —É—á–µ–±–Ω–æ–π –Ω–µ–¥–µ–ª–∏ –∑–∞–ø—É—â–µ–Ω!")
    bot.infinity_polling()
