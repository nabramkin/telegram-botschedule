import telebot
import json
import os
from datetime import datetime, timedelta
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
from flask import Flask
import threading
import random

TOKEN = os.getenv('TOKEN')
bot = telebot.TeleBot(TOKEN)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
days_map = {
    '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–ø–Ω': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '1': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', 'monday': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
    '–≤—Ç–æ—Ä–Ω–∏–∫': '–≤—Ç–æ—Ä–Ω–∏–∫', '–≤—Ç': '–≤—Ç–æ—Ä–Ω–∏–∫', '2': '–≤—Ç–æ—Ä–Ω–∏–∫', 'tuesday': '–≤—Ç–æ—Ä–Ω–∏–∫',
    '—Å—Ä–µ–¥–∞': '—Å—Ä–µ–¥–∞', '—Å—Ä': '—Å—Ä–µ–¥–∞', '3': '—Å—Ä–µ–¥–∞', 'wednesday': '—Å—Ä–µ–¥–∞',
    '—á–µ—Ç–≤–µ—Ä–≥': '—á–µ—Ç–≤–µ—Ä–≥', '—á—Ç': '—á–µ—Ç–≤–µ—Ä–≥', '4': '—á–µ—Ç–≤–µ—Ä–≥', 'thursday': '—á–µ—Ç–≤–µ—Ä–≥',
    '–ø—è—Ç–Ω–∏—Ü–∞': '–ø—è—Ç–Ω–∏—Ü–∞', '–ø—Ç': '–ø—è—Ç–Ω–∏—Ü–∞', '5': '–ø—è—Ç–Ω–∏—Ü–∞', 'friday': '–ø—è—Ç–Ω–∏—Ü–∞',
    '—Å—É–±–±–æ—Ç–∞': '—Å—É–±–±–æ—Ç–∞', '—Å–±': '—Å—É–±–±–æ—Ç–∞', '6': '—Å—É–±–±–æ—Ç–∞', 'saturday': '—Å—É–±–±–æ—Ç–∞',
    '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–≤—Å': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '7': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', 'sunday': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
}

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–∏–º–æ—à–∏ ‚ú®
schedule = {
  "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üéØ –í–Ω–µ—É—Ä–æ—á–∫–∞: –†–∞–∑–≥–æ–≤–æ—Ä—ã –æ –≤–∞–∂–Ω–æ–º"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üß† –í–Ω–µ—É—Ä–æ—á–∫–∞: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å"}
  ],
  "–≤—Ç–æ—Ä–Ω–∏–∫": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üåç –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üî¢ –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}
  ],
  "—Å—Ä–µ–¥–∞": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üèÉ‚Äç‚ôÇÔ∏è –í–Ω–µ—É—Ä–æ—á–∫–∞: –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üéµ –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú—É–∑—ã–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üî® –¢—Ä—É–¥"}
  ],
  "—á–µ—Ç–≤–µ—Ä–≥": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üé® –í–Ω–µ—É—Ä–æ—á–∫–∞: –ò–ó–û"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üèõÔ∏è –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–æ—è –ú–æ—Å–∫–≤–∞"}
  ],
  "–ø—è—Ç–Ω–∏—Ü–∞": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "üìñ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "üåç –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "üèÉ‚Äç‚ôÇÔ∏è –í–Ω–µ—É—Ä–æ—á–∫–∞: –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "üî¢ –í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}
  ],
  "—Å—É–±–±–æ—Ç–∞": [{"–≤—Ä–µ–º—è": "–≤–µ—Å—å –¥–µ–Ω—å", "—É—Ä–æ–∫": "üòé –í—ã—Ö–æ–¥–Ω–æ–π! –û—Ç–¥—ã—Ö–∞–π!"}],
  "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ": [{"–≤—Ä–µ–º—è": "–≤–µ—Å—å –¥–µ–Ω—å", "—É—Ä–æ–∫": "üò¥ –í—ã—Ö–æ–¥–Ω–æ–π! –°–ø–∏ –¥–æ–ª—å—à–µ!"}]
}

print("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–∏–º–æ—à–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! ‚ú®")

# üé® –ö–†–£–¢–ê–Ø –ö–õ–ê–í–ò–ê–¢–£–†–ê —Å –¥–∞—Ç–∞–º–∏ (2x4 + 1)
def get_days_keyboard():
    today = datetime.now()
    russian_days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", 
                   "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"]
    
    markup = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    
    buttons = []
    for i in range(7):
        current_day = today + timedelta(days=i)
        day_index = current_day.weekday()
        day_name = russian_days[day_index]
        date_str = current_day.strftime("%d.%m")
        
        # –¶–≤–µ—Ç–Ω—ã–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –¥–Ω–µ–π ‚ú®
        emojis = ["üîµ", "üü¢", "üü°", "üü†", "üî¥", "üü£", "‚ö´"]
        button_text = f"{emojis[i%7]} {date_str} ({day_name})"
        buttons.append(KeyboardButton(button_text))
    
    # 2 —Ä—è–¥–∞ –ø–æ 4 –∫–Ω–æ–ø–∫–∏ + –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞
    for i in range(0, 8, 2):
        if i+1 < len(buttons):
            markup.row(buttons[i], buttons[i+1])
        else:
            markup.add(buttons[i])
    
    return markup

# üöÄ –°–¢–ê–†–¢–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê —Å –º–µ–º–æ–º
@bot.message_handler(commands=['start'])
def start(message):
    greetings = [
        "üîî –ü—Ä–∏–≤–µ—Ç, –¢–∏–º–æ—à–∞! –ì–æ—Ç–æ–≤ —É–∑–Ω–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ? ‚ú®",
        "üéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ö–∞–∫–æ–π –¥–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üìÖ",
        "üëã –¢–∏–º–æ—à–∞, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –æ–Ω–ª–∞–π–Ω! üöÄ"
    ]
    bot.reply_to(message, 
        random.choice(greetings) + "\n\n–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏:",
        reply_markup=get_days_keyboard())

# üß† –£–ú–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types=['text'])
def handle_day(message):
    day_input = message.text.lower().strip()
    
    # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏ –¥–∞—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫
    day_input = ''.join(c for c in day_input if c.isalpha() or c.isspace())
    day_input = day_input.replace('üìÖ', '').replace('üîµ', '').replace('üü¢', '').replace('üü°', '').replace('üü†', '').replace('üî¥', '').replace('üü£', '').replace('‚ö´', '')
    day_input = ' '.join(day_input.split())  # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    
    # –ò—â–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    day = None
    for key in days_map:
        if key in day_input:
            day = days_map[key]
            break
    
    if not day:
        bot.reply_to(message, 
            "‚ùì –ù–µ –ø–æ–Ω—è–ª –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ üòÖ\n\n"
            "–ù–∞–ø–∏—à–∏: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –≤—Ç–æ—Ä–Ω–∏–∫... –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –∫–Ω–æ–ø–∫—É:",
            reply_markup=get_days_keyboard())
        return
    
    if day not in schedule or not schedule[day]:
        bot.reply_to(message, 
            f"üìÖ –ù–∞ <b>{day.capitalize()}</b> —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç! üéâ –û—Ç–¥—ã—Ö–∞–π!",
            parse_mode='HTML', reply_markup=get_days_keyboard())
        return
    
    # –ö—Ä–∞—Å–∏–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚ú®
    text = f"üìö <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ {day.capitalize()}</b>\n\n"
    for lesson in schedule[day]:
        text += f"‚è∞ <b>{lesson['–≤—Ä–µ–º—è']}</b> ‚Äî {lesson['—É—Ä–æ–∫']}\n"
    
    # –°–ª—É—á–∞–π–Ω—ã–π —Å–æ–≤–µ—Ç
    tips = [
        "üí™ –£—á–∏—Å—å —Ö–æ—Ä–æ—à–æ, –¢–∏–º–æ—à–∞!",
        "üìñ –ß–∏—Ç–∞–π —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º!",
        "üéØ –î—É–º–∞–π –∏ —Ä–µ—à–∞–π –∑–∞–¥–∞—á–∏!",
        "‚ú® –¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è —Å–æ –≤—Å–µ–º! üí™"
    ]
    text += f"\n<i>{random.choice(tips)}</i>"
    
    bot.reply_to(message, text, parse_mode='HTML', reply_markup=get_days_keyboard())

# /HELP –∫–æ–º–∞–Ω–¥–∞
@bot.message_handler(commands=['help'])
def help_command(message):
    bot.reply_to(message, 
        "üÜò <b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É:</b>\n\n"
        "üìÖ <b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "‚Ä¢ /start ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "‚Ä¢ /help ‚Äî –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "üìù <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>\n"
        "‚Ä¢ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É —Å –¥–∞—Ç–æ–π\n"
        "‚Ä¢ –ò–ª–∏ –Ω–∞–ø–∏—à–∏: –ø–Ω, –≤—Ç, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫...\n\n"
        "‚ú® –†–∞–±–æ—Ç–∞–µ—Ç 24/7 –Ω–∞ Render!",
        parse_mode='HTML', reply_markup=get_days_keyboard())

# –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Render
app = Flask(__name__)

@app.route("/")
def hello():
    return "üîî Telegram –±–æ—Ç –¢–∏–º–æ—à–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! üöÄ"

def run_flask():
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)

if __name__ == "__main__":
    flask_thread = threading.Thread(target=run_flask)
    flask_thread.daemon = True
    flask_thread.start()
    
    print("üöÄ –ë–æ—Ç –¢–∏–º–æ—à–∏ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! ‚ú®")
    bot.infinity_polling()
