import telebot
import json
import os
from datetime import datetime, timedelta  # ‚Üê –ù–û–í–û–ï!
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
from flask import Flask
import threading



TOKEN = os.getenv('TOKEN')  # –¢–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Render
bot = telebot.TeleBot(TOKEN)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
days_map = {
    '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–ø–Ω': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '1': '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
    '–≤—Ç–æ—Ä–Ω–∏–∫': '–≤—Ç–æ—Ä–Ω–∏–∫', '–≤—Ç': '–≤—Ç–æ—Ä–Ω–∏–∫', '2': '–≤—Ç–æ—Ä–Ω–∏–∫',
    '—Å—Ä–µ–¥–∞': '—Å—Ä–µ–¥–∞', '—Å—Ä': '—Å—Ä–µ–¥–∞', '3': '—Å—Ä–µ–¥–∞',
    '—á–µ—Ç–≤–µ—Ä–≥': '—á–µ—Ç–≤–µ—Ä–≥', '—á—Ç': '—á–µ—Ç–≤–µ—Ä–≥', '4': '—á–µ—Ç–≤–µ—Ä–≥',
    '–ø—è—Ç–Ω–∏—Ü–∞': '–ø—è—Ç–Ω–∏—Ü–∞', '–ø—Ç': '–ø—è—Ç–Ω–∏—Ü–∞', '5': '–ø—è—Ç–Ω–∏—Ü–∞',
    '—Å—É–±–±–æ—Ç–∞': '—Å—É–±–±–æ—Ç–∞', '—Å–±': '—Å—É–±–±–æ—Ç–∞', '6': '—Å—É–±–±–æ—Ç–∞',
    '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–≤—Å': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '7': '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
}

# ‚úÖ –†–ê–°–ü–ò–°–ê–ù–ò–ï –í–°–¢–†–û–ï–ù–ù–û–ï –í –ö–û–î (–ù–ï –ù–£–ñ–ï–ù schedule.json)
schedule = {
  "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –†–∞–∑–≥–æ–≤–æ—Ä—ã –æ –≤–∞–∂–Ω–æ–º"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å"}
  ],
  "–≤—Ç–æ—Ä–Ω–∏–∫": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "–®–∞—Ö–º–∞—Ç—ã"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "–û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}
  ],
  "—Å—Ä–µ–¥–∞": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –ú—É–∑—ã–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "–¢—Ä—É–¥"}
  ],
  "—á–µ—Ç–≤–µ—Ä–≥": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –ò–ó–û"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–æ—è –ú–æ—Å–∫–≤–∞"}
  ],
  "–ø—è—Ç–Ω–∏—Ü–∞": [
    {"–≤—Ä–µ–º—è": "8:00-8:40", "—É—Ä–æ–∫": "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"},
    {"–≤—Ä–µ–º—è": "9:00-9:40", "—É—Ä–æ–∫": "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"},
    {"–≤—Ä–µ–º—è": "10:00-10:40", "—É—Ä–æ–∫": "–û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä"},
    {"–≤—Ä–µ–º—è": "10:50-11:30", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"},
    {"–≤—Ä–µ–º—è": "11:50-12:30", "—É—Ä–æ–∫": "–í–Ω–µ—É—Ä–æ—á–∫–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}
  ],
  "—Å—É–±–±–æ—Ç–∞": [{"–≤—Ä–µ–º—è": "–≤–µ—Å—å –¥–µ–Ω—å", "—É—Ä–æ–∫": "–≤—ã—Ö–æ–¥–Ω–æ–π"}],
  "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ": [{"–≤—Ä–µ–º—è": "–≤–µ—Å—å –¥–µ–Ω—å", "—É—Ä–æ–∫": "–≤—ã—Ö–æ–¥–Ω–æ–π"}]
}
print("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –¥–Ω—è–º–∏
from datetime import datetime  # ‚Üê –î–û–ë–ê–í–¨ –≤ –∏–º–ø–æ—Ä—Ç—ã –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ (–ó–ê–ú–ï–ù–ò —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é)
def get_days_keyboard():
    today = datetime.now()
    days = []
    
    for i in range(7):  # –°–µ–≥–æ–¥–Ω—è + 6 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
        current_day = today + timedelta(days=i)
        day_name = current_day.strftime("%A").lower()  # –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –≤—Ç–æ—Ä–Ω–∏–∫...
        date_str = current_day.strftime("%d.%m")  # 03.02
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å –¥–∞—Ç–æ–π
        days.append(KeyboardButton(f"üìÖ {date_str} ({day_name.capitalize()})"))
    
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add(*days)  # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
    return markup


@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message, 
        "üîî –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º —É—Ä–æ–∫–æ–≤ –¢–∏–º–æ—à–∏.\n"
        "–ù–∞–ø–∏—à–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
        reply_markup=get_days_keyboard())

@bot.message_handler(content_types=['text'])
def handle_day(message):
    day_input = message.text.lower().strip().replace('üìÖ ', '')
    day = days_map.get(day_input)
    
    if not day:
        bot.reply_to(message, 
            "‚ùå –ù–µ –ø–æ–Ω—è–ª –¥–µ–Ω—å. –í—ã–±–µ—Ä–∏ –∏–∑ –∫–Ω–æ–ø–æ–∫ –∏–ª–∏ –Ω–∞–ø–∏—à–∏: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –≤—Ç–æ—Ä–Ω–∏–∫...", 
            reply_markup=get_days_keyboard())
        return
    
    if day not in schedule or not schedule[day]:
        bot.reply_to(message, f"üìÖ –ù–∞ {day.capitalize()} —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç!", reply_markup=get_days_keyboard())
        return
    
    text = f"üìö –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ <b>{day.capitalize()}</b>:\n\n"
    for lesson in schedule[day]:
        text += f"‚è∞ <b>{lesson['–≤—Ä–µ–º—è']}</b> - {lesson['—É—Ä–æ–∫']}\n"
    
    bot.reply_to(message, text, parse_mode='HTML', reply_markup=get_days_keyboard())

# –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Render (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
app = Flask(__name__)

@app.route("/")
def hello():
    return "üîî Telegram –±–æ—Ç —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º —É—Ä–æ–∫–æ–≤ –¢–∏–º–æ—à–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!"

def run_flask():
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)

if __name__ == "__main__":
    flask_thread = threading.Thread(target=run_flask)
    flask_thread.daemon = True
    flask_thread.start()
    
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    bot.infinity_polling()
